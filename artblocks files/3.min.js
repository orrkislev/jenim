function roundPatch(e,t=v_rel(.5,.5),n){let a=[];return a=getEllipse(e*R.random(.8,1.2)*threadSize,e*R.random(.8,1.2)*threadSize,45),a.forEach(e=>e.mult(R.random(.8,2))),a.forEach(e=>e.add(t)),a=toCrv(a),makePatch(a,n)}function rectPatch(e,t){const n=R.random(100,700),a=R.random(100,700),i=new SquarePatternShape(e.x-n/2,e.y-a/2,n,a);return i.rotate(R.random(-15,15)),ps=i.ps,makePatch(ps,t)}function makePatch(e,t){const n=new LayoutPattern2(e),a=new Denim(n,t,0).rotate(R.random(360)).calc();a.warpExtensions=[5,20],a.extendChance=R.random(.2,.4),applyPatchShadow(a);const i=patchStitches(a),o=R.random_dec()<.5;return{denim:a,stitches:i,fringe:o}}function applyPatchShadow(e){innerPattern=new LayoutPattern2(e.lp.getOffset(-3*globalScale)),innerPattern.ps.forEach(e=>e.add(5*globalScale,5*globalScale)),innerPattern.toCrv();const t=createGraphics(width,height);t.background(255),t.noStroke(),t.fill(0),t.beginShape(),innerPattern.crv().forEach(e=>t.vertex(e.x,e.y)),t.endShape(),t.filter(BLUR,10*globalScale),e.weft.forEach(e=>{e.forEach(e=>{if(e.ps.length>0){const n=e.ps[0],a=t.get(n.x,n.y);brightness(a)<360&&(e.darkness=brightness(a)/1500)}})})}function applyPatch3dEffect(e,t){innerPattern=new LayoutPattern2(e.lp.getOffset(0)),innerPattern.ps.forEach(e=>e.add(5,5)),innerPattern.toCrv();const n=createGraphics(width,height);n.background(0),n.noStroke(),n.fill(255,20),innerPattern.crv().forEach(e=>n.circle(e.x,e.y,R.random(50))),innerPattern.crv().forEach(e=>n.circle(e.x,e.y,R.random(30))),innerPattern.crv().forEach(e=>n.circle(e.x,e.y,R.random(10))),t.weft.forEach(e=>{e.forEach(e=>{if(e.ps.length>0){const t=e.ps[0],a=n.get(t.x,t.y);brightness(a)<360&&(e.age=brightness(a)/1500)}})})}function patchStitches(e){threadSize=initialThreadSize;let t=[];const n=R.random_choice([1,2,3]);if(1==n)t=crossStitches(e.lp,R.random(2,8),[35,3,3,3]);else if(2==n){if(t=e.lp.stitches(6,5,5,!0),R.random_dec()<.5&&(t=t.concat(e.lp.stitches(7,5,5,!0))),R.random_dec()<.4)for(let n=1;n<R.random(3);n++)t=t.concat(e.lp.stitches(6+R.random(5,40),5,5,!0))}else 3==n&&(t=e.lp.stitches(-6,5,5,!0),R.random_dec()<.5&&(t=t.concat(e.lp.stitches(-7,5,5,!0))),R.random_dec()<.7&&(t=t.concat(e.lp.stitches(-3,5,5,!0))));return t}async function drawStitches(e){for(const t of e)await new Loop(t.slice(0,2),t[2]?patchStitchColor:t[2],1.7*initialThreadSize).wiggle().shadow().draw(),await timeout(0)}function crossStitches(e,t,n){let a=[...e.ps];a.push(e.ps[0]),a=toCrv(a);const i=[];for(let e=0;e<a.length;e+=n.rotate())i.push(a[e]);e.ps=i;const o=e.getOffset(t),r=e.getOffset(-t),d=[];for(let e=0;e<o.length;e++)o[e].add(R.random(-2,2),R.random(-2,2)),r[e].add(R.random(-2,2),R.random(-2,2)),d.push([o[e],r[e]]);return d}async function simple(){denim=new Denim(fullPattern,denimColor).rotate(R.random(360)),denim.calc().makeRips(),applyColorFunc(denim,dyePattern1),background(BG),await denim.draw(),await denim.finishDraw()}async function patches(){const e=R.random()<.5;denim=new Denim(fullPattern,denimColor).rotate(R.random(360));const t=!e&&R.random_dec()<.5,n=e||R.random_dec()<.3?1:R.random(3),a=[];for(let t=0;t<n;t++){const t=e&&R.random()<.5?v_rel(.5,.5):v_rel(R.random(.2,.8),R.random(.2,.8));R.random_dec()<.5?a.push(roundPatch(baseWidth*R.random(.1,.25),t,denimColor)):a.push(rectPatch(t,denimColor))}if(e){a[0].denim.lp.center();stitches=[];const e=R.random_choice([1,2,3]);let t=patchStitchColor;const n=a[0].denim.lp.bounds(),i=1==e?15:0,o=R.random(),r=R.random(),d=R.random_choice([0,1,2]);for(let e=n.left-100;e<n.right+100;e+=R.random(30,40)){1==d&&(t=R.random_choice([color(255,0,0),color(0),color(255)]));for(let a=n.top-R.random(100);a<n.bottom+R.random(100);a+=R.random(30,40)){2==d&&R.random_choice([color(255,0,0),color(0),color(255)]);const n=R.random(30,40);let s=!0,c=!0;R.random()<o&&(R.random()<r?s=!1:c=!1),s&&stitches.push([v(e+i,a),v(e-i,a+n),t]),c&&stitches.push([v(e-n/2,a+n/2-i),v(e+n/2,a+n/2+i),t]),a+=n}e+=R.random(30,40)}}denim.calc().makeRips(),applyColorFunc(denim,dyePattern1);for(let e=0;e<a.length;e++)denim.ripExtendMasks.push(a[e].denim),applyPatch3dEffect(a[e].denim,denim);background(BG),await denim.draw({dontFringe:t}),threadSize=1.5*initialThreadSize;for(let t=0;t<a.length;t++)await a[t].denim.draw({dontFringe:a.fringe}),(!e||e&&R.random()<.5)&&await drawStitches(a[t].stitches),await a[t].denim.finishDraw();e&&await drawStitches(stitches),await denim.finishDraw()}async function largeRips(){denim=new Denim(fullPattern,neighborColor(denimColor,0,0,-150)).rotate(R.random(360)),denim.visibleWhite=1,denim.darkness=.3,denim.calc(),denim2=new Denim(fullPattern,denimColor).rotate(R.random(360)),ripNoiseScale=[R.random(4,8),R.random(4,8)],denim2.ripThreshold=R.random(.3,.5),denim2.calc().makeRips(),applyColorFunc(denim2,dyePattern1),denim2.dropShadowOn([denim]),background(BG),await denim.draw({dontFringe:!0}),await denim2.draw(),await denim2.finishDraw()}async function withDivide(){dyePattern2=getColorFunc(),flipped=R.random()<.5,withFringe=R.random()<.5,pos1=R.random_choice(["left","right","top","bottom"]),pos2=R.random()<.1&&R.random_choice(["left","right","top","bottom"]),!pos2&&R.random()<.5&&("left"==pos1?pos2="right":"right"==pos1?pos2="left":"top"==pos1?pos2="bottom":"bottom"==pos1&&(pos2="top")),denim_bg=new Denim(fullPattern,denimColor).rotate(R.random(360)).calc(),denim_top1=divideTopDenim(pos1),denim_bg.ripExtendMasks.push(denim_top1),pos2&&(denim_top2=divideTopDenim(pos2),denim_top1.ripExtendMasks.push(denim_top2),denim.ripExtendMasks.push(denim_top2)),applyColorFunc(denim_bg,dyePattern1),background(BG),await denim_bg.draw({dontFringe:!0}),await denim_bg.finishDraw(),await denim_top1.draw({dontFringe:!1}),await denim_top1.finishDraw(),pos2&&(await denim_top2.draw({dontFringe:!1}),await denim_top2.finishDraw())}function divideTopDenim(e){let t,n;["left","right"].includes(e)?(t=v(.2*-baseWidth,baseHeight*R.random(.18,.82)),n=v(1.2*baseWidth,baseHeight*R.random(.18,.82))):(t=v(baseWidth*R.random(.18,.82),.2*-baseHeight),n=v(baseWidth*R.random(.18,.82),1.2*baseHeight));const a=R.random()<.75?R.random(2,8):1,i=vsub(n,t).div(a),o=[];for(let e=1;e<a+1;e++){const r=vlerp(t,n,e/a);r.add(i.copy().rotate(90).mult(R.random(-1,1)/a)),o.push(r)}let r,d;o.push(n),o.unshift(t),"left"==e?(r=v(.2*-baseWidth,.2*-baseHeight),d=v(1.2*baseWidth,.2*-baseHeight)):"right"==e?(o.reverse(),r=v(1.2*baseWidth,1.2*baseHeight),d=v(.2*-baseWidth,1.2*baseHeight)):"top"==e?(o.reverse(),r=v(.2*-baseWidth,1.2*baseHeight),d=v(.2*-baseWidth,.2*-baseHeight)):(r=v(1.2*baseWidth,.2*-baseHeight),d=v(1.2*baseWidth,1.2*baseHeight));const s=[r,...o,d];return pattern_top=new LayoutPattern2(s).fillet(50),newDenim=new Denim(pattern_top,denimColor).rotate(R.random(-360)),flipped&&(newDenim.visibleWhite=1),newDenim.age=.2,newDenim.ripThreshold=R.random(.1,.45),newDenim.calc().makeRips(),applyColorFunc(newDenim,dyePattern2),newDenim.dropShadowOn([denim_bg]),withFringe?(newDenim.warpExtensions=[R.random(40,100),R.random(100,200)],newDenim.extendChance=R.random(.7,1)):newDenim.foldedStitchings(),newDenim}function setup(){noiseSeed(R.random_int(2e4)),1.4*windowWidth>windowHeight?canvas=createCanvas(windowHeight/1.4,windowHeight):canvas=createCanvas(windowWidth,1.4*windowWidth),globalScale=width/baseWidth,angleMode(DEGREES),noLoop(),noStroke(),noFill(),ripNoiseScale=[R.random(5,10),R.random(5,10)],initialThreadSize=1.2,threadSize=initialThreadSize;const e=new Date,t=e.getFullYear()-2023,n=t+e.getMonth()/12;globalAge=constrain(n/10,0,1),fullPattern=new SquarePatternShape(0,0,baseWidth,baseHeight),makeImage()}async function makeImage(){background(BG),fill(255),textSize(10),textAlign(CENTER,CENTER),text("Loading Jenim",width/2,height/2),noFill(),await timeout(30),initDenimParams(),initBaseColor(),composition=R.random_choice([withDivide,patches,largeRips,simple]),dyePattern1=getColorFunc(),await composition(),print("done")}const warpColors=natural;let stitchColor;const BG="#666",baseWidth=1e3,baseHeight=1.4*baseWidth;let globalScale;