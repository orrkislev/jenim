function roundPatch(e,t=v_rel(.5,.5),n){let a=[];return a=getEllipse(e*R.random(.8,1.2)*threadSize,e*R.random(.8,1.2)*threadSize,45),a.forEach(e=>e.mult(R.random(.8,2))),a.forEach(e=>e.add(t)),a=toCrv(a),makePatch(a,n)}function rectPatch(e,t){const n=R.random(100,600),a=R.random(100,600),o=new SquarePatternShape(e.x-n/2,e.y-a/2,n,a);return o.rotate(R.random(-15,15)),ps=o.ps,makePatch(ps,t)}function makePatch(e,t){const n=new LayoutPattern2(e),a=new Denim(n,t,0).rotate(R.random(360)).calc();applyPatchShadow(a);const o=patchStitches(a),r=R.random_dec()<.5;return{denim:a,stitches:o,fringe:r}}function applyPatchShadow(e){innerPattern=new LayoutPattern2(e.lp.getOffset(-3*globalScale)),innerPattern.ps.forEach(e=>e.add(5*globalScale,5*globalScale)),innerPattern.toCrv();const t=createGraphics(width,height);t.background(255),t.noStroke(),t.fill(0),t.beginShape(),innerPattern.crv().forEach(e=>t.vertex(e.x,e.y)),t.endShape(),t.filter(BLUR,10*globalScale),e.weft.forEach(e=>{e.forEach(e=>{if(e.ps.length>0){const n=e.ps[0],a=t.get(n.x,n.y);brightness(a)<360&&(e.darkness=brightness(a)/1500)}})})}function applyPatch3dEffect(e,t){innerPattern=new LayoutPattern2(e.lp.getOffset(0)),innerPattern.ps.forEach(e=>e.add(5,5)),innerPattern.toCrv();const n=createGraphics(width,height);n.background(0),n.noStroke(),n.fill(255,20),innerPattern.crv().forEach(e=>n.circle(e.x,e.y,R.random(50))),innerPattern.crv().forEach(e=>n.circle(e.x,e.y,R.random(30))),innerPattern.crv().forEach(e=>n.circle(e.x,e.y,R.random(10))),t.weft.forEach(e=>{e.forEach(e=>{if(e.ps.length>0){const t=e.ps[0],a=n.get(t.x,t.y);brightness(a)<360&&(e.age=brightness(a)/1500)}})})}function patchStitches(e){threadSize=initialThreadSize;let t=[];const n=R.random_choice([1,2,3]);if(1==n)t=crossStitches(e.lp,R.random(2,8),[35,3,3,3]);else if(2==n){if(t=e.lp.stitches(6,5,5,!0),R.random_dec()<.5&&(t=t.concat(e.lp.stitches(7,5,5,!0))),R.random_dec()<.4)for(let n=1;n<R.random(3);n++)t=t.concat(e.lp.stitches(6+R.random(5,40),5,5,!0))}else 3==n&&(t=e.lp.stitches(-6,5,5,!0),R.random_dec()<.5&&(t=t.concat(e.lp.stitches(-7,5,5,!0))),R.random_dec()<.7&&(t=t.concat(e.lp.stitches(-3,5,5,!0))));return t}async function drawStitches(e){for(const t of e)await new Loop(t,patchStitchColor,1.4*initialThreadSize).wiggle().shadow().draw(),await timeout(0)}function crossStitches(e,t,n){let a=[...e.ps];a.push(e.ps[0]),a=toCrv(a);const o=[];for(let e=0;e<a.length;e+=n.rotate())o.push(a[e]);e.ps=o;const r=e.getOffset(t),i=e.getOffset(-t),d=[];for(let e=0;e<r.length;e++)r[e].add(R.random(-2,2),R.random(-2,2)),i[e].add(R.random(-2,2),R.random(-2,2)),d.push([r[e],i[e]]);return d}async function patches(){const e=R.random()<.5;denim=new Denim(fullPattern,denimColor).rotate(R.random(360));const t=!e&&R.random_dec()<.5,n=e||R.random_dec()<.3?1:R.random(3),a=[];for(let t=0;t<n;t++){const t=e&&R.random()<.5?v_rel(.5,.5):v_rel(R.random(.2,.8),R.random(.2,.8));R.random_dec()<.5?a.push(roundPatch(baseWidth*R.random(.1,.25),t,denimColor)):a.push(rectPatch(t,denimColor))}if(e){const e=a[0].denim.lp.center();stitches=[];const t=R.random_choice([0,1,2,3]);if(0==t){let t=0,n=50;const a=R.random(100,200);for(let o=0;o<a;o++){const a=2*PI*n,o=R.random(20,30);a2=t+o/a*360,r2=n+R.random(1,2),stitches.push([vadd(e,v(n,0).rotate(t)),vadd(e,v(r2,0).rotate(a2))]),t=a2+R.random(8,15),n=r2}}else{const e=a[0].denim.lp.bounds(),n=1==t?15:0,o=R.random(),r=R.random();for(let t=e.left-100;t<e.right+100;t+=R.random(30,40)){for(let a=e.top-R.random(100);a<e.bottom+R.random(100);a+=R.random(30,40)){const e=R.random(30,40);let i=!0,d=!0;R.random()<o&&(R.random()<r?i=!1:d=!1),i&&stitches.push([v(t+n,a),v(t-n,a+e)]),d&&stitches.push([v(t-e/2,a+e/2-n),v(t+e/2,a+e/2+n)]),a+=e}t+=R.random(30,40)}}}denim.calc().makeRips(),applyColorFunc(denim,dyePattern1);for(let e=0;e<a.length;e++)applyPatch3dEffect(a[e].denim,denim);background(BG),await denim.draw({dontFringe:t});for(let t=0;t<a.length;t++)await a[t].denim.draw({dontFringe:a.fringe}),(!e||e&&R.random()<.5)&&await drawStitches(a[t].stitches);e&&await drawStitches(stitches)}async function largeRips(){denim=new Denim(fullPattern,neighborColor(denimColor,0,0,-150)).rotate(R.random(360)),denim.visibleWhite=1,denim.darkness=.3,denim.calc(),denim2=new Denim(fullPattern,denimColor).rotate(R.random(360)),ripNoiseScale=[R.random(4,8),R.random(4,8)],denim2.ripThreshold=R.random(.3,.5),denim2.calc().makeRips(),applyColorFunc(denim2,dyePattern1),denim2.dropShadowOn([denim]),background(BG),await denim.draw({dontFringe:!0}),await denim2.draw()}async function withDivide(){dyePattern2=getColorFunc();const e=R.random()<.5,t=R.random()<.5,n=R.random()<.5;let a,o;denim_bg=new Denim(fullPattern,denimColor).rotate(R.random(360)).calc(),n?(a=v(.2*-baseWidth,baseHeight*R.random(.18,.82)),o=v(1.2*baseWidth,baseHeight*R.random(.18,.82))):(a=v(baseWidth*R.random(.18,.82),.2*-baseHeight),o=v(baseWidth*R.random(.18,.82),1.2*baseHeight));const r=R.random()<.75?R.random(2,8):1,i=vsub(o,a).div(r),d=[];for(let e=1;e<r+1;e++){const t=vlerp(a,o,e/r);t.add(i.copy().rotate(90).mult(R.random(-1,1)/r)),d.push(t)}let c,s;d.push(o),d.unshift(a),n?R.random()<.5?(c=v(.2*-baseWidth,.2*-baseHeight),s=v(1.2*baseWidth,.2*-baseHeight)):(d.reverse(),c=v(1.2*baseWidth,1.2*baseHeight),s=v(.2*-baseWidth,1.2*baseHeight)):R.random()<.5?(d.reverse(),c=v(.2*-baseWidth,1.2*baseHeight),s=v(.2*-baseWidth,.2*-baseHeight)):(c=v(1.2*baseWidth,.2*-baseHeight),s=v(1.2*baseWidth,1.2*baseHeight));const h=[c,...d,s];pattern_top=new LayoutPattern2(h).fillet(50),denim_top=new Denim(pattern_top,denimColor).rotate(R.random(-360)),e&&(denim_top.visibleWhite=1),denim_top.age=.2,denim_top.ripThreshold=R.random(.1,.45),denim_top.calc().makeRips(),applyColorFunc(denim_bg,dyePattern1),applyColorFunc(denim_top,dyePattern2),denim_top.foldedStitchings(),denim_top.dropShadowOn([denim_bg]),t&&(denim_top.warpExtensions=[R.random(40,100),R.random(100,200)],denim_top.extendChance=R.random(.7,1)),background(BG),await denim_bg.draw({dontFringe:!0}),await denim_top.draw({dontFringe:!1})}function setup(){noiseSeed(R.random_int(2e4)),1.4*windowWidth>windowHeight?canvas=createCanvas(windowHeight/1.4,windowHeight):canvas=createCanvas(windowWidth,1.4*windowWidth),globalScale=width/baseWidth,angleMode(DEGREES),noLoop(),noStroke(),noFill(),ripNoiseScale=[R.random(5,10),R.random(5,10)],initialThreadSize=R.random(1.3,2.5),threadSize=initialThreadSize;const e=new Date,t=e.getFullYear()-2023,n=t+e.getMonth()/12;globalAge=constrain(n/10,0,1),fullPattern=new SquarePatternShape(0,0,baseWidth,baseHeight),makeImage()}async function makeImage(){background(BG),fill(255),textSize(10),textAlign(CENTER,CENTER),text("Loading Jenim",width/2,height/2),noFill(),await timeout(30),initDenimParams(),initBaseColor(),composition=R.random_choice([withDivide,patches,largeRips]),dyePattern1=getColorFunc(),await composition(),print("done")}const warpColors=natural;let stitchColor;const BG="#666",baseWidth=1e3,baseHeight=1.4*baseWidth;let globalScale;