function roundPatch(e,t=v_rel(.5,.5),n){let a=[];return a=getEllipse(e*R.random(.8,1.2)*threadSize,e*R.random(.8,1.2)*threadSize,45),a.forEach(e=>e.mult(R.random(.8,2))),a.forEach(e=>e.add(t)),a=toCrv(a),makePatch(a,n)}function rectPatch(e,t){const n=R.random(100,600),a=R.random(100,600),o=new SquarePatternShape(e.x-n/2,e.y-a/2,n,a);return o.rotate(R.random(-15,15)),ps=o.ps,makePatch(ps,t)}function makePatch(e,t){const n=new LayoutPattern2(e),a=new Denim(n,t,0).rotate(R.random(360)).calc();a.warpExtensions=[5,20],a.extendChance=R.random(.2,.4),applyPatchShadow(a);const o=patchStitches(a),i=R.random_dec()<.5;return{denim:a,stitches:o,fringe:i}}function applyPatchShadow(e){innerPattern=new LayoutPattern2(e.lp.getOffset(-3*globalScale)),innerPattern.ps.forEach(e=>e.add(5*globalScale,5*globalScale)),innerPattern.toCrv();const t=createGraphics(width,height);t.background(255),t.noStroke(),t.fill(0),t.beginShape(),innerPattern.crv().forEach(e=>t.vertex(e.x,e.y)),t.endShape(),t.filter(BLUR,10*globalScale),e.weft.forEach(e=>{e.forEach(e=>{if(e.ps.length>0){const n=e.ps[0],a=t.get(n.x,n.y);brightness(a)<360&&(e.darkness=brightness(a)/1500)}})})}function applyPatch3dEffect(e,t){innerPattern=new LayoutPattern2(e.lp.getOffset(0)),innerPattern.ps.forEach(e=>e.add(5,5)),innerPattern.toCrv();const n=createGraphics(width,height);n.background(0),n.noStroke(),n.fill(255,20),innerPattern.crv().forEach(e=>n.circle(e.x,e.y,R.random(50))),innerPattern.crv().forEach(e=>n.circle(e.x,e.y,R.random(30))),innerPattern.crv().forEach(e=>n.circle(e.x,e.y,R.random(10))),t.weft.forEach(e=>{e.forEach(e=>{if(e.ps.length>0){const t=e.ps[0],a=n.get(t.x,t.y);brightness(a)<360&&(e.age=brightness(a)/1500)}})})}function patchStitches(e){threadSize=initialThreadSize;let t=[];const n=R.random_choice([1,2,3]);if(1==n)t=crossStitches(e.lp,R.random(2,8),[35,3,3,3]);else if(2==n){if(t=e.lp.stitches(6,5,5,!0),R.random_dec()<.5&&(t=t.concat(e.lp.stitches(7,5,5,!0))),R.random_dec()<.4)for(let n=1;n<R.random(3);n++)t=t.concat(e.lp.stitches(6+R.random(5,40),5,5,!0))}else 3==n&&(t=e.lp.stitches(-6,5,5,!0),R.random_dec()<.5&&(t=t.concat(e.lp.stitches(-7,5,5,!0))),R.random_dec()<.7&&(t=t.concat(e.lp.stitches(-3,5,5,!0))));return t}async function drawStitches(e){for(const t of e)await new Loop(t,patchStitchColor,1.7*initialThreadSize).wiggle().shadow().draw(),await timeout(0)}function crossStitches(e,t,n){let a=[...e.ps];a.push(e.ps[0]),a=toCrv(a);const o=[];for(let e=0;e<a.length;e+=n.rotate())o.push(a[e]);e.ps=o;const i=e.getOffset(t),r=e.getOffset(-t),d=[];for(let e=0;e<i.length;e++)i[e].add(R.random(-2,2),R.random(-2,2)),r[e].add(R.random(-2,2),R.random(-2,2)),d.push([i[e],r[e]]);return d}async function simple(){denim=new Denim(fullPattern,denimColor).rotate(R.random(360)),denim.calc().makeRips(),applyColorFunc(denim,dyePattern1),background(BG),await denim.draw()}async function patches(){const e=R.random()<.5;denim=new Denim(fullPattern,denimColor).rotate(R.random(360));const t=!e&&R.random_dec()<.5,n=e||R.random_dec()<.3?1:R.random(3),a=[];for(let t=0;t<n;t++){const t=e&&R.random()<.5?v_rel(.5,.5):v_rel(R.random(.2,.8),R.random(.2,.8));R.random_dec()<.5?a.push(roundPatch(baseWidth*R.random(.1,.25),t,denimColor)):a.push(rectPatch(t,denimColor))}if(e){const e=a[0].denim.lp.center();stitches=[];const t=R.random_choice([0,1,2,3]);if(0==t){let t=0,n=50;const a=R.random(100,200);for(let o=0;o<a;o++){const a=2*PI*n,o=R.random(20,30);a2=t+o/a*360,r2=n+R.random(1,2),stitches.push([vadd(e,v(n,0).rotate(t)),vadd(e,v(r2,0).rotate(a2))]),t=a2+R.random(8,15),n=r2}}else{const e=a[0].denim.lp.bounds(),n=1==t?15:0,o=R.random(),i=R.random();for(let t=e.left-100;t<e.right+100;t+=R.random(30,40)){for(let a=e.top-R.random(100);a<e.bottom+R.random(100);a+=R.random(30,40)){const e=R.random(30,40);let r=!0,d=!0;R.random()<o&&(R.random()<i?r=!1:d=!1),r&&stitches.push([v(t+n,a),v(t-n,a+e)]),d&&stitches.push([v(t-e/2,a+e/2-n),v(t+e/2,a+e/2+n)]),a+=e}t+=R.random(30,40)}}}denim.calc().makeRips(),applyColorFunc(denim,dyePattern1);for(let e=0;e<a.length;e++)applyPatch3dEffect(a[e].denim,denim);background(BG),await denim.draw({dontFringe:t});for(let t=0;t<a.length;t++)await a[t].denim.draw({dontFringe:a.fringe}),(!e||e&&R.random()<.5)&&await drawStitches(a[t].stitches);e&&await drawStitches(stitches)}async function largeRips(){denim=new Denim(fullPattern,neighborColor(denimColor,0,0,-150)).rotate(R.random(360)),denim.visibleWhite=1,denim.darkness=.3,denim.calc(),denim2=new Denim(fullPattern,denimColor).rotate(R.random(360)),ripNoiseScale=[R.random(4,8),R.random(4,8)],denim2.ripThreshold=R.random(.3,.5),denim2.calc().makeRips(),applyColorFunc(denim2,dyePattern1),denim2.dropShadowOn([denim]),background(BG),await denim.draw({dontFringe:!0}),await denim2.draw()}async function withDivide(){dyePattern2=getColorFunc(),flipped=R.random()<.5,withFringe=R.random()<.5,pos1=R.random_choice(["left","right","top","bottom"]),pos2=R.random()<.1&&R.random_choice(["left","right","top","bottom"]),!pos2&&R.random()<.5&&("left"==pos1?pos2="right":"right"==pos1?pos2="left":"top"==pos1?pos2="bottom":"bottom"==pos1&&(pos2="top")),denim_bg=new Denim(fullPattern,denimColor).rotate(R.random(360)).calc(),denim_top1=divideTopDenim(pos1),pos2&&(denim_top2=divideTopDenim(pos2)),applyColorFunc(denim_bg,dyePattern1),background(BG),await denim_bg.draw({dontFringe:!0}),await denim_top1.draw({dontFringe:!1}),pos2&&await denim_top2.draw({dontFringe:!1})}function divideTopDenim(e){let t,n;["left","right"].includes(e)?(t=v(.2*-baseWidth,baseHeight*R.random(.18,.82)),n=v(1.2*baseWidth,baseHeight*R.random(.18,.82))):(t=v(baseWidth*R.random(.18,.82),.2*-baseHeight),n=v(baseWidth*R.random(.18,.82),1.2*baseHeight));const a=R.random()<.75?R.random(2,8):1,o=vsub(n,t).div(a),i=[];for(let e=1;e<a+1;e++){const r=vlerp(t,n,e/a);r.add(o.copy().rotate(90).mult(R.random(-1,1)/a)),i.push(r)}let r,d;i.push(n),i.unshift(t),"left"==e?(r=v(.2*-baseWidth,.2*-baseHeight),d=v(1.2*baseWidth,.2*-baseHeight)):"right"==e?(i.reverse(),r=v(1.2*baseWidth,1.2*baseHeight),d=v(.2*-baseWidth,1.2*baseHeight)):"top"==e?(i.reverse(),r=v(.2*-baseWidth,1.2*baseHeight),d=v(.2*-baseWidth,.2*-baseHeight)):(r=v(1.2*baseWidth,.2*-baseHeight),d=v(1.2*baseWidth,1.2*baseHeight));const s=[r,...i,d];return pattern_top=new LayoutPattern2(s).fillet(50),newDenim=new Denim(pattern_top,denimColor).rotate(R.random(-360)),flipped&&(newDenim.visibleWhite=1),newDenim.age=.2,newDenim.ripThreshold=R.random(.1,.45),newDenim.calc().makeRips(),applyColorFunc(newDenim,dyePattern2),newDenim.dropShadowOn([denim_bg]),withFringe?(newDenim.warpExtensions=[R.random(40,100),R.random(100,200)],newDenim.extendChance=R.random(.7,1)):newDenim.foldedStitchings(),newDenim}function setup(){noiseSeed(R.random_int(2e4)),1.4*windowWidth>windowHeight?canvas=createCanvas(windowHeight/1.4,windowHeight):canvas=createCanvas(windowWidth,1.4*windowWidth),globalScale=width/baseWidth,angleMode(DEGREES),noLoop(),noStroke(),noFill(),ripNoiseScale=[R.random(5,10),R.random(5,10)],initialThreadSize=R.random(1.3,2.5),threadSize=initialThreadSize;const e=new Date,t=e.getFullYear()-2023,n=t+e.getMonth()/12;globalAge=constrain(n/10,0,1),fullPattern=new SquarePatternShape(0,0,baseWidth,baseHeight),makeImage()}async function makeImage(){background(BG),fill(255),textSize(10),textAlign(CENTER,CENTER),text("Loading Jenim",width/2,height/2),noFill(),await timeout(30),initDenimParams(),initBaseColor(),composition=R.random_choice([withDivide,patches,largeRips,simple]),dyePattern1=getColorFunc(),await composition(),print("done")}const warpColors=natural;let stitchColor;const BG="#666",baseWidth=1e3,baseHeight=1.4*baseWidth;let globalScale;