class Random{constructor(){this.usage=0,this.useA=!1;let t=function(t){let e=parseInt(t.substr(0,8),16),r=parseInt(t.substr(8,8),16),i=parseInt(t.substr(16,8),16),s=parseInt(t.substr(24,8),16);return function(){i|=0;let t=((e|=0)+(r|=0)|0)+(s|=0)|0;return s=s+1|0,e=r^r>>>9,r=i+(i<<3)|0,i=(i=i<<21|i>>>11)+t|0,(t>>>0)/4294967296}};this.prngA=new t(tokenData.hash.substr(2,32)),this.prngB=new t(tokenData.hash.substr(34,32));for(let e=0;e<1e6;e+=2)this.prngA(),this.prngB()}random_dec(){return this.usage++,this.useA=!this.useA,this.useA?this.prngA():this.prngB()}random_num(t,e){return t+(e-t)*this.random_dec()}random_int(t,e){return Math.floor(this.random_num(t,e+1))}random_choice(t){return t[this.random_int(0,t.length-1)]}random=(t=1,e=0)=>this.random_num(t,e);random_in=t=>this.random_num(t[0],t[1])}let R=new Random;p5.Color.prototype.toRGB=function t(){return color(red(this),green(this),blue(this),alpha(this))},Array.prototype.rotate=function t(){return this.push(this.shift()),this[0]};const v=(t,e)=>createVector(t,e),v_rel=(t,e)=>createVector(t*baseWidth,e*baseHeight);let allDots=0;async function drawDot(t){++allDots%2e4==0&&await timeout(0),point(t.x,t.y)}function timeout(t){return new Promise(e=>setTimeout(e,t))}async function burn(t,e,r=7){blendMode(BURN),fill(30,30,90,r),noStroke(),circle(t.x,t.y,e*R.random(.4,1)),blendMode(BLEND)}function getPointOnEllipse(t,e,r){return createVector(.5*t*cos(r),.5*e*sin(r))}function getEllipse(t,e,r=1,i=0,s=360){let a=[];for(let o=i;o<s;o+=r)a.push(getPointOnEllipse(t,e,o));return a}function makeCurve(t){t.push(t[t.length-1]),t.splice(0,0,t[0]);let e=[];for(let r=0;r<t.length-3;r++){let i=t[r+1],s=t[r+2],a=p5.Vector.dist(i,s);for(let o=0;o<a;o++)x=curvePoint(t[r].x,t[r+1].x,t[r+2].x,t[r+3].x,o/a),y=curvePoint(t[r].y,t[r+1].y,t[r+2].y,t[r+3].y,o/a),e.push(createVector(x,y))}return e}function crvLength(t){l=0;for(let e=0;e<t.length-1;e++)l+=p5.Vector.dist(t[e],t[e+1]);return l}function placeOnCurve(t,e){let r=0;for(let i=0;i<t.length-1;i++)if((r+=sqrt((t[i].x-t[i+1].x)**2+(t[i].y-t[i+1].y)**2))>=e)return t[i];return!1}function initDenimParams(){warpSpacingMinMax=[.8,2],weftSpacingMinMax=[.8,1],startOffset=[2,1,0],patternTop=[2],patternBottom=[1],specialWeave=!1,.07>R.random_dec()&&(specialWeave=!0,startOffset=Array(R.random_int(1,3)).fill(0).map((t,e)=>e),patternTop=Array(R.random_int(1,3)).fill(0).map(t=>R.random_int(1,3)),patternBottom=Array(R.random_int(1,3)).fill(0).map(t=>R.random_int(1,3)))}class Denim{constructor(t,e,r=.5){this.layoutPattern=t,this.color=e,this.visibleWhite=R.random(.5,1),this.darkness=R.random(.3),this.noiseScale=R.random(200,400),this.warpExtensions=[15,40],this.extendChance=.5,this.age=r,this.rotation=0,this.ripNoiseZ=R.random(1e3),this.ripThreshold=R.random(.18,.32),this.ripMin=R.random(30,70)*initialThreadSize,this.ripMax=R.random(this.ripMin,160)*initialThreadSize}rotate(t){return this.rotation=t,this}calc(t={}){return this.ripThreshold+=.3*globalAge,this.age+=globalAge,this.ripMin-=30*globalAge,this.ripMax-=70*globalAge,this.warp||this.makeWarp(),this.weft||this.makeWeft(),t.dontTrim||this.trim(),t.dontUnravel||this.unravel(),t.dontAge||this.doAge(),this}async draw(t={}){threadSize=initialThreadSize,t.dontWarp||await this.drawWarp(),t.dontWeft||await this.drawWeft(),t.dontFringe||await this.extendWarps(),this.hasRips&&await this.drawRips(),t.dontStitch||await this.layoutPattern.drawStitches(this)}makeWarp(){let t=this.layoutPattern.rotatedContainingSquare(this.rotation),{pos:e,w:r,h:i,rotation:s}=t.getDimension(),a=p5.Vector.fromAngle(radians(s)).setMag(r),o=a.copy().rotate(PI/2).normalize(),n=5*initialThreadSize,h=e.copy().add(o.copy().setMag(n).mult(-1)),$=h.copy().add(a).add(),p=Array(15).fill(0).map((t,e)=>p5.Vector.lerp(h,$,e/14));p.forEach(t=>t.add(o.copy().mult(R.random(-n,n)))),this.warp=[p];let f=!0;for(;f;){let d=this.warp[this.warp.length-1],c=d.map(t=>t.copy());c.forEach(t=>t.add(o.copy().mult(threadSize*R.random(warpSpacingMinMax[0],warpSpacingMinMax[1])))),this.warp.push(c),f=!1,c.forEach((t,e)=>{p5.Vector.dist(t,p[e])<i&&(f=!0)})}this.warp=this.warp.map(t=>makeCurve(t))}async drawWarp(){let t=0;for(let e of(threadSize=initialThreadSize/2,this.warp)){let r=lerpColor(color(warpColors[0]),color(warpColors[1]),R.random_dec());await thread(e,r,2),t++%10==0&&await timeout(0)}}async extendWarps(){for(let t of this.warp){if(R.random_dec()<this.extendChance){let e=p5.Vector.sub(t[0],t[1]);await franzim(t[0],e,threadSize*R.random_in(this.warpExtensions))}if(R.random_dec()<this.extendChance){let r=p5.Vector.sub(t[t.length-1],t[t.length-2]);await franzim(t[t.length-1],r,threadSize*R.random_in(this.warpExtensions))}await timeout(0)}}makeWeft(){threadSize=initialThreadSize,this.weft=[{column:this.warp.map(t=>t[0]),threadSize}];let t=crvLength(this.warp.reduce((t,e)=>crvLength(t)>crvLength(e)?t:e));for(let e=0;e<t;e+=threadSize*R.random_in(weftSpacingMinMax))this.weft.push({column:this.warp.map(t=>placeOnCurve(t,e)).filter(t=>!1!=t),threadSize}),threadSize=initialThreadSize*R.random(1,1.2);let r=color(this.color),i=lerpColor(r,color(255),this.visibleWhite);this.weft=this.weft.map(t=>{let e=[],s=[r,i];for(let a=0;a<startOffset[0]-1;a++)s.rotate();for(let o=startOffset.rotate();o<t.column.length;o+=patternBottom.rotate()){let n=t.column.slice(o,o+patternTop.rotate()+1);o+=patternTop[0];let h=s.rotate();h=lerpColor(h,color(0),noise(n[0].x/this.noiseScale,n[0].y/this.noiseScale)*this.darkness),e.push(new Loop(n,h,t.threadSize))}return e})}async drawWeft(){let t=0;for(let e of this.weft){for(let r of e)await r.draw();t++%10==0&&await timeout(0)}}hasWeftOn(t){for(let e of this.weft)for(let r of e)for(let i of r.ps)if(i&&5>p5.Vector.dist(t,i))return r;return!1}trim(){this.warp=this.warp.map(t=>t.filter(t=>this.layoutPattern.pointInPattern(t))),this.warp=this.warp.filter(t=>t.length>1),this.weft=this.weft.map(t=>t.filter(t=>t.ps.filter(t=>this.layoutPattern.pointInPattern(t)).length>1)),this.warp=this.warp.map(t=>t.filter(t=>t.x>=-(.1*baseWidth)&&t.x<=1.1*baseWidth&&t.y>=-(.1*baseHeight)&&t.y<=1.1*baseHeight))}unravel(){this.weft.forEach(t=>{t.length>4&&(t[0].ps.forEach(t=>t.add(threadSize*R.random(-.3,.3),threadSize*R.random(-.3,.3))),t[t.length-1].ps.forEach(t=>t.add(threadSize*R.random(-.3,.3),threadSize*R.random(-.3,.3))))})}pointInRip(t){return noise(ripNoiseScale[0]*t.x/baseWidth,ripNoiseScale[1]*t.y/baseHeight,this.ripNoiseZ)<this.ripThreshold}makeRips(){this.warpRips=[],this.weftRips=[];for(let t=0;t<this.warp.length;t++){let e=this.warp[t],r=[];if(0!=e.length)for(let i=0;i<200;i++){let s=e[floor(e.length*i/200)];if(this.pointInRip(s))r.push(i);else{if(r.length>2){let a=r.map(t=>floor(t*e.length/200)),o=a.map(t=>e[t]),n=crvLength(o),h=o[0].copy(),$=o[1].copy(),p=o[o.length-1].copy(),f=o[o.length-2].copy();if(n>this.ripMin&&n<this.ripMax){let d=[];for(let c=0;c<=5;c++)d.push(p5.Vector.lerp(h,p,c/5).add(0,R.random(-2,4)));d=makeCurve(d),e.splice(a[0],a[a.length-1]-a[0],...d)}n>this.ripMax&&(this.warpRips.push({pos:h,dir:p5.Vector.sub($,h),len:n*R.random(.1,.5)}),this.warpRips.push({pos:p,dir:p5.Vector.sub(f,p),len:n*R.random(.1,.5)}),e.splice(a[0],a[a.length-1]-a[0]))}r=[]}}}let u=!0;return this.weft.forEach(t=>t.forEach((t,e)=>{let r=t.ps.filter(t=>!this.pointInRip(t)).length>0;if(r&&u||!r&&!u){let i=t.ps.filter(t=>null!=t)[0],s=p5.Vector.sub(t.ps[1],t.ps[0]);r?i.add(s):i.sub(s),this.weftRips.push({pos:i,dir:u?t.dir().mult(-1):t.dir()}),u=!u}})),this.weft.forEach(t=>t.forEach(t=>t.ps=t.ps.filter(t=>!this.pointInRip(t)))),this.hasRips=!0,this}async drawRips(){let t=0;for(let e of this.warpRips)await franzim(e.pos,e.dir,e.len),t++%10==0&&await timeout(0);let r=0;for(let i of(this.weftRips=this.weftRips.filter(t=>.7>R.random_dec()),this.weftRips)){let s=color(this.color);if(this.weft.forEach(t=>t.forEach(t=>t.ps.forEach(e=>{e&&10>p5.Vector.dist(e,i.pos)&&(s=t.getFinalColor())}))),s.setAlpha(50),.25>R.random_dec()){stroke(s);for(let a=0;a<R.random(1,5);a++)await tinyThread(i.pos.copy().mult(globalScale),R.random(3,10))}else{let o=[i.pos.copy(),i.pos.copy()],n=i.dir.setMag(4*globalScale),h=R.random(6,12);for(let $=0;$<h;$++)n.rotate(R.random(-25,25)),o.push(o[o.length-1].copy().add(n));await thread(o,s,5,50)}r++%30==0&&await timeout(0)}}doAge(){floor(this.weft.length/2),this.weft.forEach((t,e)=>{for(let r=0;r<t.length;r++){let i=t[r].ps[0],s=1-dist(i.x,i.y,baseWidth/2,baseHeight/2)/(baseHeight/2);t[r].age=s*this.age/2,t[r].yellow=s*this.age/2}})}dropShadowOn(t){let e=createGraphics(baseWidth,baseHeight);for(let r of(e.noStroke(),e.fill(0,10),this.weft.forEach(t=>{t.forEach(t=>{e.circle(t.x+10,t.y+10,threadSize*R.random(10))})}),t))r.weft.forEach(t=>{t.forEach(t=>{if(t.ps.length>0){let r=t.ps[0],i=e.get(r.x,r.y);alpha(i)>0&&(t.darkness=.2-alpha(i)/255/5)}})})}foldedStitchings(t){t||(t=this.layoutPattern);let e=createGraphics(baseWidth,baseHeight);e.noStroke();let r=new LayoutPattern2(t.ps),i=.5>R.random()?[15]:[7,35];for(let s of(e.fill(255,100),r.ps=t.getOffset(0),r.getCurve().forEach(t=>e.circle(t.x,t.y,R.random(6)*initialThreadSize)),e.fill(255,20),i))r.ps=t.getOffset(s+5),r.getCurve().forEach(t=>e.circle(t.x,t.y,R.random(6)*initialThreadSize));for(let a of(e.fill(0,20),i))r.ps=t.getOffset(a),r.getCurve().forEach(t=>e.circle(t.x,t.y,R.random(9))*initialThreadSize);for(let o=0;o<i.length;o++)r.ps=t.getOffset(i[o]-15),r.getCurve().forEach((t,r)=>{let i=(sin(8*r)+1)/2;e.fill(255*i,7),e.circle(t.x,t.y,R.random(5,25)*initialThreadSize)});return this.weft.forEach(t=>{t.forEach(t=>{if(t.ps.length>0){let r=t.ps[0],i=e.get(r.x,r.y);alpha(i)>0&&(t.age=brightness(i)/360*(alpha(i)/255),t.yellow&&(t.yellow=0),t.darkness=.25-brightness(i)/360*(alpha(i)/255)/4)}})}),t.setStitches(stitchTypes.DOUBLE,i),this}}